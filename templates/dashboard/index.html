<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Spidermind - 学术人才信息爬虫系统</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .stats-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 15px;
            transition: transform 0.2s;
        }
        .stats-card:hover {
            transform: translateY(-5px);
        }
        .task-card {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            border-radius: 15px;
        }
        .parse-card {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            border-radius: 15px;
        }
        .coverage-card {
            background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
            color: white;
            border-radius: 15px;
        }
        .health-good {
            background: linear-gradient(135deg, #56ab2f 0%, #a8e6cf 100%);
        }
        .health-warning {
            background: linear-gradient(135deg, #f7971e 0%, #ffd200 100%);
        }
        .health-critical {
            background: linear-gradient(135deg, #e53e3e 0%, #f56565 100%);
        }
        .action-btn {
            border-radius: 25px;
            padding: 12px 30px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
            transition: all 0.3s;
        }
        .action-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }
        .activity-item {
            border-left: 4px solid #007bff;
            background-color: #f8f9fa;
            border-radius: 0 8px 8px 0;
            transition: all 0.2s;
        }
        .activity-item:hover {
            background-color: #e9ecef;
            transform: translateX(5px);
        }
        .progress-ring {
            width: 100px;
            height: 100px;
        }
        .coverage-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }
        .coverage-item {
            background: white;
            border-radius: 10px;
            padding: 15px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            text-align: center;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container">
            <a class="navbar-brand" href="/">
                <i class="fas fa-spider me-2"></i>Spidermind
            </a>
            <div class="navbar-nav ms-auto">
                <a class="nav-link active" href="/"><i class="fas fa-home me-1"></i>首页</a>
                <a class="nav-link" href="/candidates"><i class="fas fa-users me-1"></i>候选人</a>
                <a class="nav-link" href="/parse/review"><i class="fas fa-cogs me-1"></i>解析管理</a>
                <a class="nav-link" href="/logs"><i class="fas fa-list me-1"></i>日志</a>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <!-- 系统健康状态横幅 -->
        <div class="row mb-4">
            <div class="col">
                <div class="card health-{{ stats.system_health.system_status }} text-white">
                    <div class="card-body text-center py-3">
                        <i class="fas fa-heartbeat fa-2x me-3"></i>
                        <span class="h5">
                            系统状态: 
                            {% if stats.system_health.system_status == 'healthy' %}
                                <i class="fas fa-check-circle"></i> 正常运行
                            {% elif stats.system_health.system_status == 'warning' %}
                                <i class="fas fa-exclamation-triangle"></i> 注意
                            {% else %}
                                <i class="fas fa-times-circle"></i> 异常
                            {% endif %}
                        </span>
                        <small class="ms-3">最近24小时错误: {{ stats.system_health.recent_errors }} 个</small>
                    </div>
                </div>
            </div>
        </div>

        <!-- 主要统计卡片 -->
        <div class="row mb-4">
            <div class="col-lg-3 col-md-6 mb-3">
                <div class="card stats-card">
                    <div class="card-body text-center">
                        <i class="fas fa-users fa-3x mb-3"></i>
                        <h2>{{ stats.parsing.total_candidates }}</h2>
                        <p class="mb-0">总候选人数</p>
                        <small>{{ stats.parsing.candidates_with_texts }} 人有原文</small>
                    </div>
                </div>
            </div>
            <div class="col-lg-3 col-md-6 mb-3">
                <div class="card task-card">
                    <div class="card-body text-center">
                        <i class="fas fa-tasks fa-3x mb-3"></i>
                        <h2>{{ stats.tasks.total.total }}</h2>
                        <p class="mb-0">总任务数</p>
                        <small>{{ stats.tasks.total.pending }} 待处理 | {{ stats.tasks.total.running }} 运行中</small>
                    </div>
                </div>
            </div>
            <div class="col-lg-3 col-md-6 mb-3">
                <div class="card parse-card">
                    <div class="card-body text-center">
                        <i class="fas fa-chart-line fa-3x mb-3"></i>
                        <h2>{{ "%.1f"|format(stats.parsing.parse_progress) }}%</h2>
                        <p class="mb-0">解析进度</p>
                        <small>{{ stats.parsing.parsed_candidates }}/{{ stats.parsing.candidates_with_texts }}</small>
                    </div>
                </div>
            </div>
            <div class="col-lg-3 col-md-6 mb-3">
                <div class="card coverage-card">
                    <div class="card-body text-center">
                        <i class="fas fa-shield-alt fa-3x mb-3"></i>
                        <h2>{{ "%.1f"|format(stats.coverage.basic_contact_percentage) }}%</h2>
                        <p class="mb-0">基础信息覆盖</p>
                        <small>{{ stats.coverage.basic_contact_coverage }} 人有联系方式</small>
                    </div>
                </div>
            </div>
        </div>

        <!-- 爬虫启动区域 -->
        <div class="row mb-4">
            <div class="col">
                <div class="card">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0"><i class="fas fa-rocket me-2"></i>爬虫任务控制</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-3 mb-3">
                                <button class="btn btn-success action-btn w-100" onclick="startCrawler('github')">
                                    <i class="fab fa-github me-2"></i>GitHub 爬虫
                                </button>
                                <div class="mt-2">
                                    {% if stats.tasks.by_source.github %}
                                    <small class="text-muted">
                                        待处理: {{ stats.tasks.by_source.github.by_status.pending }}
                                        | 已完成: {{ stats.tasks.by_source.github.by_status.done }}
                                    </small>
                                    {% else %}
                                    <small class="text-muted">暂无任务</small>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="col-md-3 mb-3">
                                <button class="btn btn-info action-btn w-100" onclick="startCrawler('openreview')">
                                    <i class="fas fa-file-alt me-2"></i>OpenReview 爬虫
                                </button>
                                <div class="mt-2">
                                    {% if stats.tasks.by_source.openreview %}
                                    <small class="text-muted">
                                        待处理: {{ stats.tasks.by_source.openreview.by_status.pending }}
                                        | 已完成: {{ stats.tasks.by_source.openreview.by_status.done }}
                                    </small>
                                    {% else %}
                                    <small class="text-muted">暂无任务</small>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="col-md-3 mb-3">
                                <button class="btn btn-warning action-btn w-100" onclick="startCrawler('homepage')">
                                    <i class="fas fa-globe me-2"></i>首页 爬虫
                                </button>
                                <div class="mt-2">
                                    {% if stats.tasks.by_source.homepage %}
                                    <small class="text-muted">
                                        待处理: {{ stats.tasks.by_source.homepage.by_status.pending }}
                                        | 已完成: {{ stats.tasks.by_source.homepage.by_status.done }}
                                    </small>
                                    {% else %}
                                    <small class="text-muted">暂无任务</small>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="col-md-3 mb-3">
                                <button class="btn btn-purple action-btn w-100" onclick="startParsing()" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border: none;">
                                    <i class="fas fa-brain me-2"></i>智能解析
                                </button>
                                <div class="mt-2">
                                    <small class="text-muted">
                                        待解析: {{ stats.parsing.pending_parse }}
                                        | 最近活动: {{ stats.parsing.recent_parse_activity }}
                                    </small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 字段覆盖率详情 -->
        <div class="row mb-4">
            <div class="col">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="fas fa-chart-pie me-2"></i>字段覆盖率统计</h5>
                    </div>
                    <div class="card-body">
                        <div class="coverage-grid">
                            <div class="coverage-item">
                                <div class="h4 text-primary">{{ "%.1f"|format(stats.coverage.coverage_percentages.email or 0) }}%</div>
                                <div class="text-muted">邮箱</div>
                                <div class="progress mt-2" style="height: 8px;">
                                    <div class="progress-bar bg-primary" style="width: {{ stats.coverage.coverage_percentages.email or 0 }}%"></div>
                                </div>
                            </div>
                            <div class="coverage-item">
                                <div class="h4 text-success">{{ "%.1f"|format(stats.coverage.coverage_percentages.phone or 0) }}%</div>
                                <div class="text-muted">电话</div>
                                <div class="progress mt-2" style="height: 8px;">
                                    <div class="progress-bar bg-success" style="width: {{ stats.coverage.coverage_percentages.phone or 0 }}%"></div>
                                </div>
                            </div>
                            <div class="coverage-item">
                                <div class="h4 text-info">{{ "%.1f"|format(stats.coverage.coverage_percentages.homepage or 0) }}%</div>
                                <div class="text-muted">主页</div>
                                <div class="progress mt-2" style="height: 8px;">
                                    <div class="progress-bar bg-info" style="width: {{ stats.coverage.coverage_percentages.homepage or 0 }}%"></div>
                                </div>
                            </div>
                            <div class="coverage-item">
                                <div class="h4 text-warning">{{ "%.1f"|format(stats.coverage.coverage_percentages.resume or 0) }}%</div>
                                <div class="text-muted">简历</div>
                                <div class="progress mt-2" style="height: 8px;">
                                    <div class="progress-bar bg-warning" style="width: {{ stats.coverage.coverage_percentages.resume or 0 }}%"></div>
                                </div>
                            </div>
                            <div class="coverage-item">
                                <div class="h4 text-dark">{{ "%.1f"|format(stats.coverage.coverage_percentages.github or 0) }}%</div>
                                <div class="text-muted">GitHub</div>
                                <div class="progress mt-2" style="height: 8px;">
                                    <div class="progress-bar bg-dark" style="width: {{ stats.coverage.coverage_percentages.github or 0 }}%"></div>
                                </div>
                            </div>
                            <div class="coverage-item">
                                <div class="h4 text-secondary">{{ "%.1f"|format(stats.coverage.coverage_percentages.institution or 0) }}%</div>
                                <div class="text-muted">机构</div>
                                <div class="progress mt-2" style="height: 8px;">
                                    <div class="progress-bar bg-secondary" style="width: {{ stats.coverage.coverage_percentages.institution or 0 }}%"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 最近活动 -->
        <div class="row">
            <div class="col">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0"><i class="fas fa-history me-2"></i>最近活动</h5>
                        <button class="btn btn-sm btn-outline-primary" onclick="refreshActivity()">
                            <i class="fas fa-sync-alt"></i> 刷新
                        </button>
                    </div>
                    <div class="card-body">
                        {% if stats.recent_activity %}
                        <div class="list-group list-group-flush">
                            {% for activity in stats.recent_activity %}
                            <div class="activity-item p-3 mb-2">
                                <div class="d-flex justify-content-between align-items-start">
                                    <div>
                                        <div class="fw-bold">
                                            <i class="fas fa-{{ 'check' if activity.status == 'success' else 'times' if activity.status == 'fail' else 'clock' }} me-2 
                                                {% if activity.status == 'success' %}text-success
                                                {% elif activity.status == 'fail' %}text-danger
                                                {% else %}text-warning{% endif %}"></i>
                                            {{ activity.source }} - {{ activity.task_type }}
                                        </div>
                                        <div class="text-muted small">{{ activity.message }}</div>
                                        {% if activity.candidate_name != '未知' %}
                                        <div class="text-primary small">
                                            <i class="fas fa-user me-1"></i>{{ activity.candidate_name }}
                                        </div>
                                        {% endif %}
                                    </div>
                                    <small class="text-muted">
                                        {{ activity.created_at[:16] if activity.created_at else '未知时间' }}
                                    </small>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                        {% else %}
                        <div class="text-center py-4">
                            <i class="fas fa-clock fa-3x text-muted mb-3"></i>
                            <h6 class="text-muted">暂无最近活动</h6>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 爬虫参数配置模态框 -->
    <div class="modal fade" id="crawlerModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">爬虫参数配置</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="crawlerForm">
                        <input type="hidden" id="crawlerSource" name="source">
                        
                        <div id="githubParams" style="display: none;">
                            <div class="mb-3">
                                <label class="form-label">最近仓库数 (recent_n)</label>
                                <input type="number" class="form-control" name="recent_n" value="5" min="1" max="20">
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Star仓库数 (star_n)</label>
                                <input type="number" class="form-control" name="star_n" value="5" min="1" max="20">
                            </div>
                            <div class="mb-3">
                                <label class="form-label">关注深度 (follow_depth)</label>
                                <input type="number" class="form-control" name="follow_depth" value="1" min="1" max="3">
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">批次大小</label>
                            <input type="number" class="form-control" name="batch_size" value="10" min="1" max="50">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">最大候选人数</label>
                            <input type="number" class="form-control" name="max_candidates" placeholder="留空处理所有">
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" onclick="submitCrawler()">启动爬虫</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let currentCrawlerSource = '';

        // 启动爬虫
        function startCrawler(source) {
            currentCrawlerSource = source;
            document.getElementById('crawlerSource').value = source;
            
            // 显示/隐藏对应参数
            const githubParams = document.getElementById('githubParams');
            githubParams.style.display = source === 'github' ? 'block' : 'none';
            
            // 更新模态框标题
            const titles = {
                'github': 'GitHub 爬虫配置',
                'openreview': 'OpenReview 爬虫配置', 
                'homepage': '首页爬虫配置'
            };
            document.querySelector('#crawlerModal .modal-title').textContent = titles[source];
            
            new bootstrap.Modal(document.getElementById('crawlerModal')).show();
        }

        // 提交爬虫任务
        async function submitCrawler() {
            const form = document.getElementById('crawlerForm');
            const formData = new FormData(form);
            
            const request = {
                source: formData.get('source'),
                batch_size: parseInt(formData.get('batch_size')) || 10,
                max_candidates: formData.get('max_candidates') ? parseInt(formData.get('max_candidates')) : null
            };
            
            // GitHub特有参数
            if (currentCrawlerSource === 'github') {
                request.recent_n = parseInt(formData.get('recent_n')) || 5;
                request.star_n = parseInt(formData.get('star_n')) || 5;
                request.follow_depth = parseInt(formData.get('follow_depth')) || 1;
            }
            
            try {
                const response = await fetch('/dashboard/crawl/start', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(request)
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    alert('爬虫任务已启动！');
                    bootstrap.Modal.getInstance(document.getElementById('crawlerModal')).hide();
                    
                    // 跳转到对应的爬虫页面
                    if (result.data.redirect_url) {
                        window.location.href = result.data.redirect_url;
                    } else {
                        setTimeout(() => location.reload(), 1000);
                    }
                } else {
                    alert('启动失败: ' + result.detail);
                }
            } catch (error) {
                alert('启动失败: ' + error.message);
            }
        }

        // 启动解析
        function startParsing() {
            window.location.href = '/parse/review';
        }

        // 刷新活动
        async function refreshActivity() {
            try {
                const response = await fetch('/dashboard/activity?limit=5');
                const result = await response.json();
                
                if (response.ok) {
                    location.reload(); // 简单刷新页面
                } else {
                    alert('刷新失败');
                }
            } catch (error) {
                alert('刷新失败: ' + error.message);
            }
        }

        // 定时刷新统计数据
        setInterval(async () => {
            try {
                const response = await fetch('/dashboard/stats');
                const result = await response.json();
                
                if (response.ok) {
                    // 更新关键数字
                    updateDashboardNumbers(result.data);
                }
            } catch (error) {
                console.log('定时刷新失败:', error);
            }
        }, 30000); // 30秒刷新一次

        function updateDashboardNumbers(stats) {
            // 这里可以更新页面上的数字，而不需要完全刷新页面
            // 为了简单起见，暂时不实现
        }
    </script>
</body>
</html>